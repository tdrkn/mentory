{
    servers {
        # Allow direct-IP HTTPS clients that don't send SNI.
        strict_sni_host insecure_off
    }
}

# Direct HTTPS listener on 443 to support clients that may omit SNI for raw IP.
:443 {
    # Static cert ensures TLS also works for clients that do not send SNI on raw IP.
    tls /etc/caddy/certs/ip.crt /etc/caddy/certs/ip.key

    # Admin panel
    handle /admin* {
        reverse_proxy api:4000
    }

    # API routes
    handle /api/* {
        reverse_proxy api:4000
    }

    # Socket.IO/WebSocket transport for chat gateway
    handle /socket.io* {
        reverse_proxy api:4000
    }

    # Web app
    handle {
        reverse_proxy web:3000
    }
}

# Explicit HTTP -> HTTPS redirect.
:80 {
    redir https://{$DOMAIN:206.81.20.68}{uri} 308
}
