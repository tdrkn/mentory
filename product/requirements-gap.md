# Gap-анализ: Отчет.pdf vs текущая реализация Mentory

Источник сравнения:
- Базовые требования/US/FR/NFR: `/Users/arxungo/Downloads/Отчет.pdf`
- Текущая реализация: `apps/api`, `apps/web`, `apps/api/prisma/schema.prisma`

Статусы:
- `Реализовано` — покрыто в текущем коде.
- `Частично` — реализовано неполно или с отклонением от формулировки.
- `Отсутствует` — в коде нет рабочей реализации.

## 1) Сильные расхождения (глобально)

1. Админский контур из отчета (жалобы, модерация контента, верификация регалий, блокировки, вывод комиссии платформы) почти полностью отсутствует в доменной модели и API.
2. В требованиях аутентификация строится вокруг `логина`, а в реализации используется `email` (и login как отдельное поле отсутствует).
3. В отчете есть сценарии и требования вокруг процесса жалоб и связанной финансовой коррекции (refund), но в текущем MVP нет отдельного complaint workflow.
4. В отчете указано автоначисление ментору после сессии (US13), а в коде выплаты происходят по запросу ментора, автоматический post-session payout job отсутствует.
5. Вводная отчета содержит модель подписки, но в текущей БД и API она не реализована как отдельный домен.
6. Нефункциональные требования (SLO/SLA, ретеншн 6 месяцев, DWH-витрина, нагрузка 50k, 99.9% доступность) не подтверждены реализацией/операционными механизмами.
7. В уведомлениях по отчету требуется email+push, но push и email queue в текущем коде не доведены до production-ready состояния.

## 2) Функциональные требования (FR1-FR22)

| FR | Статус | Комментарий |
|---|---|---|
| FR1 (регистрация: почта+логин+пароль+роль) | Частично | Есть регистрация по email/паролю (`apps/api/src/modules/auth/dto/register.dto.ts`), но `username/login` нет, роль при self-signup только `mentor/mentee`, админ создается отдельно bootstrap-ом. |
| FR2 (согласие с пользовательским соглашением) | Частично | На UI есть автосогласие/ссылка (`apps/web/src/routes/register/+page.svelte`), но нет персистентного хранения факта согласия в БД. |
| FR3 (авторизация по логину/паролю + восстановление) | Частично | Вход есть, но по `email`, не по `логину` (`apps/api/src/modules/auth/strategies/local.strategy.ts`). Восстановление пароля по email реализовано. |
| FR4 (профили mentor/mentee с возрастом, образованием, навыками и т.д.) | Реализовано | Поля и валидации 18..120 есть в DTO/Prisma (`profiles/dto/*`, `schema.prisma`). |
| FR5 (чат: text/photo/docs/emoji) | Частично | Бэкенд поддерживает типы `text/file/image/emoji` + лимиты (`chat.service.ts`, `send-message.dto.ts`), но UI чата сейчас только текстовый (`apps/web/src/routes/chat/+page.svelte`). |
| FR6 (видеосвязь через чат) | Частично | Видео есть через `sessions/:id/video` и кнопку в чате (`chat/+page.svelte`), но модель отличается: генерируется room URL, а не универсальная кнопка передачи внешней ссылки как основной поток. |
| FR7 (поиск ментора по критериям) | Реализовано | Поиск и фильтры по цене/рейтингу/образованию/работе/хобби/навыкам есть в API+UI (`discovery.service.ts`, `mentors/+page.svelte`). |
| FR8 (запись в свободный слот) | Реализовано | Бронирование слота и статусы реализованы (`booking.service.ts`, `sessions/booking`). |
| FR9 (оплата + таймер 10 минут + эквайринг) | Реализовано | Hold 10 минут, checkout URL, методы `qr/card/cbr`, запрет дубликата оплаты (`booking.service.ts`, `payments.service.ts`, `checkout/[sessionId]/+page.svelte`). |
| FR10 (просмотр профиля ментора и тарифов) | Реализовано | Публичный профиль + тарифы/слоты доступны (`discovery.service.ts`, `mentors/[id]/+page.svelte`). |
| FR11 (отзывы 1..5, после сессии, 1:1) | Реализовано | Ограничения по рейтингу, post-session, окно +24ч, уникальность пары учтены (`sessions.service.ts#createReview`, `create-review.dto.ts`). |
| FR12 (ментор: слоты + тарифы) | Реализовано | Управление сервисами/слотами реализовано (`scheduling.service.ts`, `/schedule`, `/profile/edit`). |
| FR13 (ментор: принять/отклонить заявку, автоотмена 3 дня) | Реализовано | Есть requested flow, approve/reject, автоотмена stale requests (`sessions.service.ts`, `dashboard/+page.svelte`). |
| FR14 (ментор видит профиль менти) | Реализовано | Есть API и страница профиля менти для ментора (`profiles.service.ts#getMenteeProfileForMentor`, `mentees/[id]/+page.svelte`). |
| FR15 (вывод средств ментором) | Частично | Пайауты и методы есть (`payouts.controller.ts`, `payments.service.ts`), но эквайринг/выплаты пока моковые. |
| FR16 (заметки ментора к сессии) | Реализовано | Приватные/shared заметки и лимиты длины реализованы (`sessions.service.ts`, `update-session-notes.dto.ts`). |
| FR17 (жалобы от mentor/mentee) | Отсутствует | Нет complaint-модулей/сущностей/контроллеров в `apps/api/src/modules` и `schema.prisma`. |
| FR18 (админ обрабатывает жалобы и отвечает) | Отсутствует | Нет admin complaint workflow. |
| FR19 (админ верифицирует документы ментора) | Отсутствует | Нет сущностей и API для очереди верификации регалий. |
| FR20 (админ модерация контента и истории действий) | Отсутствует | Нет модели moderation actions/audit trail на уровне функционального workflow. |
| FR21 (админ блокировка/разблокировка пользователей) | Отсутствует | Нет доменной реализации block/unblock с историей решений. |
| FR22 (админ выводит комиссию платформы) | Отсутствует | Платформенная комиссия считается в payment (`platformFee`), но нет admin withdrawal процесса. |

## 3) Нефункциональные требования (NFR1-NFR18)

| NFR | Статус | Комментарий |
|---|---|---|
| NFR1 (все поля обязательные) | Отсутствует | В модели и DTO много опциональных полей по дизайну MVP. |
| NFR2 (непустые возраст/цена/пол/стаж) | Частично | Возраст и цена валидируются в ряде форм; `пол` и `стаж` не являются обязательными системно. |
| NFR3 (время отклика под 1k/10k/50k запросов) | Отсутствует | Нет подтвержденного perf-профиля/нагрузочных тестов под указанные пороги. |
| NFR4 (лаг данных <= 1 мин) | Отсутствует | Нет отдельного data-lag контракта/механизма контроля. |
| NFR5 (выгрузка в bdm.historical_data) | Отсутствует | DWH/витрина не реализованы. |
| NFR6 (хранение 6 месяцев) | Отсутствует | Retention policy/TTL jobs не обнаружены. |
| NFR7 (формат ссылок PLATFORM/####) | Отсутствует | Такой формат URL не enforced. |
| NFR8 (PDF <=128MB) | Частично | Ограничение 128MB есть в chat attachments; отдельного verified-doc workflow нет. |
| NFR9 (JSON) | Реализовано | API и payload-и JSON-ориентированы. |
| NFR10 (PDF формат) | Частично | PDF поддерживается в attachments, но бизнес-процесс верификации PDF отсутствует. |
| NFR11 (PNG/JPG) | Частично | image attachments поддерживаются в чате; отдельный процесс жалоб/верификации не реализован. |
| NFR12 (лицензированные интеграции) | Частично | Используются `daily`/mock acquirer; юридическое подтверждение лицензий в коде не отражено. |
| NFR13 (масштаб по заявкам/менторам) | Отсутствует | Нет подтверждения capacity и ограничений такого масштаба. |
| NFR14 (99.9%, RTO<=30m, RPO<=5m) | Отсутствует | SLO/SRE-контур в репозитории не зафиксирован. |
| NFR15 (нагрузка 50k одновременных пользователей) | Отсутствует | Нет верифицированных стресс-тестов/архитектурных гарантий. |
| NFR16 (push + email уведомления) | Частично | In-app уведомления есть; push в TODO, email queue заглушена (`notifications.service.ts`). |
| NFR17 (до 10 одновременных админов без деградации) | Отсутствует | Специальные тесты/ограничители не обнаружены. |
| NFR18 (время ответа <=24ч) | Отсутствует | SLA поддержки как исполняемый процесс не реализован. |

## 4) User Stories (US1-US16)

| US | Статус | Комментарий |
|---|---|---|
| US1 Регистрация/вход | Частично | Базовый поток есть, но не покрыта концепция login username и verification как обязательный gate. |
| US2 Профиль | Реализовано | Профили и редактирование присутствуют. |
| US3 Чат | Реализовано | Диалоги + сообщения + read/typing. |
| US4 Видеосессия | Частично | Видеокомната есть, но отличается от формулировки "ссылка на сторонний ВКС как основной поток". |
| US5 Поиск ментора | Реализовано | Фильтры и каталог реализованы. |
| US6 Профиль ментора | Реализовано | Карточка/профиль/услуги/рейтинги есть. |
| US7 Запись к ментору | Реализовано | Slot booking + статус запроса + подтверждение. |
| US8 Оплата | Реализовано | Pre-checkout, таймер, способы, обработка ошибок. |
| US9 Отзыв | Реализовано | Ограничения и сохранение отзыва реализованы. |
| US10 Тарифы ментора | Реализовано | CRUD сервисов/тарифов есть. |
| US11 Подтверждение/отклонение | Реализовано | В дашборде ментора + backend workflow. |
| US12 Календарь ментора | Реализовано | Правила доступности, исключения, слоты. |
| US13 Автоматическая оплата ментору | Частично | Есть payout flow, но нет автоначисления после 5 рабочих дней по условиям отчета. |
| US14 Жалобы | Отсутствует | Нет complaint-модуля и UI. |
| US15 Модерация контента | Отсутствует | Нет полноценных moderation workflows. |
| US16 Верификация регалий | Отсутствует | Нет upload queue + admin verify/reject процесса. |

## 5) Рекомендуемый порядок закрытия разрывов

1. Добавить доменные сущности и API для админ-контура: `complaints`, `complaint_messages`, `mentor_regalia`, `moderation_actions`, `user_blocks`, `platform_withdrawals`.
2. Синхронизировать identity-модель с требованиями: `username/login` + хранение согласий пользователя (`user_agreements`).
3. Довести payouts/notifications до production-уровня: автоначисления, не-mock очереди email, push delivery.
4. Зафиксировать NFR как исполняемые артефакты: нагрузочные тесты, SLO/SLA, retention jobs, observability метрики.
