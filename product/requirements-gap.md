# Gap-анализ: Отчет.pdf vs текущая реализация Mentory

Источник сравнения:
- Базовые требования/US/FR/NFR: `/Users/arxungo/Downloads/Отчет.pdf`
- Текущая реализация: `apps/api`, `apps/web`, `apps/api/prisma/schema.prisma`

Статусы:
- `Реализовано` — покрыто в текущем коде.
- `Частично` — реализовано неполно или с отклонением от формулировки.
- `Отсутствует` — в коде нет рабочей реализации.

## 1) Сильные расхождения (глобально)

1. Trust-контур из отчета (жалобы, модерация, верификация регалий, блокировки, вывод комиссии) реализован в API/БД и web (`/trust`, `/admin/trust`), но часть операторских сценариев в UI упрощена относительно отчета (например, чат по регалии без deep-link на конкретного пользователя).
2. Блок auth по US1/UC1/UC2 доведен до обязательного email verification gate, лимита неудачных входов (5 попыток/15 минут) и обязательного checkbox принятия условий при регистрации.
3. Complaint workflow появился (жалобы, переписка, назначение админа, закрытие), но связанная бизнес-автоматизация refund требует отдельной доработки payments-flow.
4. В отчете указано автоначисление ментору после сессии (US13), а в коде выплаты происходят по запросу ментора, автоматический post-session payout job отсутствует.
5. Вводная отчета содержит модель подписки, но в текущей БД и API она не реализована как отдельный домен.
6. Нефункциональные требования (SLO/SLA, ретеншн 6 месяцев, DWH-витрина, нагрузка 50k, 99.9% доступность) не подтверждены реализацией/операционными механизмами.
7. В уведомлениях по отчету требуется email+push, но push и email queue в текущем коде не доведены до production-ready состояния.

## 2) Функциональные требования (FR1-FR22)

| FR | Статус | Комментарий |
|---|---|---|
| FR1 (регистрация: почта+логин+пароль+роль) | Частично | Добавлен `username` в регистрацию и модель пользователя (`register.dto.ts`, `schema.prisma`). Self-signup роли: `mentor/mentee`; админ отдельно через bootstrap. |
| FR2 (согласие с пользовательским соглашением) | Реализовано | Добавлен обязательный checkbox согласия в форме регистрации и валидация на API (`register/+page.svelte`, `validators/auth.ts`, `auth/dto/register.dto.ts`), факт принятия фиксируется в `user_agreements` (`auth.service.ts`, `schema.prisma`). |
| FR3 (авторизация по логину/паролю + восстановление) | Реализовано | Вход по `login` (username или email) через local strategy (`local.strategy.ts`, `auth.service.ts`), восстановление пароля по email реализовано, добавлена временная блокировка после 5 неудачных попыток на 15 минут (UC2). |
| FR4 (профили mentor/mentee с возрастом, образованием, навыками и т.д.) | Реализовано | Поля и валидации 18..120 есть в DTO/Prisma (`profiles/dto/*`, `schema.prisma`). |
| FR5 (чат: text/photo/docs/emoji) | Реализовано | В чате реализованы `text/photo/docs/emoji`: лимит 1000 символов, фото до 128MB, документы `.pptx/.pdf/.txt/.mvd`, фиксированный список emoji (`apps/web/src/routes/chat/+page.svelte`, `chat.service.ts`). |
| FR6 (видеосвязь через чат) | Частично | В чате есть кнопка ВКС и отправка ссылки на встречу (`apps/web/src/routes/chat/+page.svelte`), но автозапуск внешнего установленного ВКС-приложения, как в отчете, не гарантируется. |
| FR7 (поиск ментора по критериям) | Реализовано | Поиск и фильтры по цене/рейтингу/образованию/работе/хобби/навыкам есть в API+UI (`discovery.service.ts`, `mentors/+page.svelte`). |
| FR8 (запись в свободный слот) | Реализовано | Бронирование слота и статусы реализованы (`booking.service.ts`, `sessions/booking`). |
| FR9 (оплата + таймер 10 минут + эквайринг) | Реализовано | Hold 10 минут, checkout URL, методы `qr/card/cbr`, запрет дубликата оплаты (`booking.service.ts`, `payments.service.ts`, `checkout/[sessionId]/+page.svelte`). |
| FR10 (просмотр профиля ментора и тарифов) | Реализовано | Публичный профиль + тарифы/слоты доступны (`discovery.service.ts`, `mentors/[id]/+page.svelte`). |
| FR11 (отзывы 1..5, после сессии, 1:1) | Реализовано | Ограничения по рейтингу, post-session, окно +24ч, уникальность пары учтены (`sessions.service.ts#createReview`, `create-review.dto.ts`). |
| FR12 (ментор: слоты + тарифы) | Реализовано | Управление сервисами/слотами реализовано (`scheduling.service.ts`, `/schedule`, `/profile/edit`). |
| FR13 (ментор: принять/отклонить заявку, автоотмена 3 дня) | Реализовано | Есть requested flow, approve/reject, автоотмена stale requests (`sessions.service.ts`, `dashboard/+page.svelte`). |
| FR14 (ментор видит профиль менти) | Реализовано | Есть API и страница профиля менти для ментора (`profiles.service.ts#getMenteeProfileForMentor`, `mentees/[id]/+page.svelte`). |
| FR15 (вывод средств ментором) | Частично | Пайауты и методы есть (`payouts.controller.ts`, `payments.service.ts`), но эквайринг/выплаты пока моковые. |
| FR16 (заметки ментора к сессии) | Реализовано | Приватные/shared заметки и лимиты длины реализованы (`sessions.service.ts`, `update-session-notes.dto.ts`). |
| FR17 (жалобы от mentor/mentee) | Реализовано | Жалоба подается через ЛК `/trust`: категория (список), дата `ДД.ММ.ГГГГ`, описание до 1000 символов, вложения `.png/.jpg/.pdf` до 128MB (`trust/+page.svelte`, `trust.service.ts`). |
| FR18 (админ обрабатывает жалобы и отвечает) | Реализовано | Админский просмотр/обработка жалоб и ответ в чате реализованы в `/admin/trust`; выдача жалоб — в очереди создания (`createdAt asc`) (`admin/trust/+page.svelte`, `trust.service.ts`). |
| FR19 (админ верифицирует документы ментора) | Частично | PDF-верификация до 128MB реализована, в админке есть действия `чат/подтвердить/не подтвердить/профиль/скачать`; остается UX-разрыв: кнопка `Чат` пока ведет в общий чат без привязки к конкретному диалогу по регалии. |
| FR20 (админ модерация контента и истории действий) | Частично | Добавлены `moderation_actions` и `admin_audit_logs` + API записи/чтения истории. |
| FR21 (админ блокировка/разблокировка пользователей) | Частично | Реализованы block/unblock в домене (`users.is_blocked`, `user_blocks`) и запрет логина для blocked users. |
| FR22 (админ выводит комиссию платформы) | Частично | Есть расчёт доступного platform balance и создание `platform_withdrawals` через admin API; фактическая интеграция провайдера выплаты не реализована. |

## 3) Нефункциональные требования (NFR1-NFR18)

| NFR | Статус | Комментарий |
|---|---|---|
| NFR1 (все поля обязательные) | Отсутствует | В модели и DTO много опциональных полей по дизайну MVP. |
| NFR2 (непустые возраст/цена/пол/стаж) | Частично | Возраст и цена валидируются в ряде форм; `пол` и `стаж` не являются обязательными системно. |
| NFR3 (время отклика под 1k/10k/50k запросов) | Отсутствует | Нет подтвержденного perf-профиля/нагрузочных тестов под указанные пороги. |
| NFR4 (лаг данных <= 1 мин) | Отсутствует | Нет отдельного data-lag контракта/механизма контроля. |
| NFR5 (выгрузка в bdm.historical_data) | Отсутствует | DWH/витрина не реализованы. |
| NFR6 (хранение 6 месяцев) | Отсутствует | Retention policy/TTL jobs не обнаружены. |
| NFR7 (формат ссылок PLATFORM/####) | Отсутствует | Такой формат URL не enforced. |
| NFR8 (PDF <=128MB) | Реализовано | Лимит 128MB enforced для PDF в чате и верификации регалий (`chat/+page.svelte`, `trust.service.ts`). |
| NFR9 (JSON) | Реализовано | API и payload-и JSON-ориентированы. |
| NFR10 (PDF формат) | Реализовано | Для регалий разрешен только PDF (`validateRegaliaFile`), для жалоб PDF также поддерживается. |
| NFR11 (PNG/JPG) | Реализовано | Для жалоб разрешены `.png/.jpg/.jpeg`, ограничения валидируются на web и API (`trust/+page.svelte`, `trust.service.ts`). |
| NFR12 (лицензированные интеграции) | Частично | Используются `daily`/mock acquirer; юридическое подтверждение лицензий в коде не отражено. |
| NFR13 (масштаб по заявкам/менторам) | Отсутствует | Нет подтверждения capacity и ограничений такого масштаба. |
| NFR14 (99.9%, RTO<=30m, RPO<=5m) | Отсутствует | SLO/SRE-контур в репозитории не зафиксирован. |
| NFR15 (нагрузка 50k одновременных пользователей) | Отсутствует | Нет верифицированных стресс-тестов/архитектурных гарантий. |
| NFR16 (push + email уведомления) | Частично | In-app уведомления есть; push в TODO, email queue заглушена (`notifications.service.ts`). |
| NFR17 (до 10 одновременных админов без деградации) | Отсутствует | Специальные тесты/ограничители не обнаружены. |
| NFR18 (время ответа <=24ч) | Отсутствует | SLA поддержки как исполняемый процесс не реализован. |

## 4) User Stories (US1-US16)

| US | Статус | Комментарий |
|---|---|---|
| US1 Регистрация/вход | Частично | Регистрация с `email/login/password`, подтверждение email и gate входа до верификации реализованы (`auth.service.ts`, `login/+page.svelte`, `verify-email/+page.svelte`), также реализован лимит 5 неудачных входов/15 минут (UC2). Остается расхождение: self-signup роли `admin`. |
| US2 Профиль | Реализовано | Профили и редактирование присутствуют. |
| US3 Чат | Реализовано | Диалоги + сообщения + read/typing. |
| US4 Видеосессия | Частично | Видеокомната есть, но отличается от формулировки "ссылка на сторонний ВКС как основной поток". |
| US5 Поиск ментора | Реализовано | Фильтры и каталог реализованы. |
| US6 Профиль ментора | Реализовано | Карточка/профиль/услуги/рейтинги есть. |
| US7 Запись к ментору | Реализовано | Slot booking + статус запроса + подтверждение. |
| US8 Оплата | Реализовано | Pre-checkout, таймер, способы, обработка ошибок. |
| US9 Отзыв | Реализовано | Ограничения и сохранение отзыва реализованы. |
| US10 Тарифы ментора | Реализовано | CRUD сервисов/тарифов есть. |
| US11 Подтверждение/отклонение | Реализовано | В дашборде ментора + backend workflow. |
| US12 Календарь ментора | Реализовано | Правила доступности, исключения, слоты. |
| US13 Автоматическая оплата ментору | Частично | Есть payout flow, но нет автоначисления после 5 рабочих дней по условиям отчета. |
| US14 Жалобы | Реализовано | Поток жалоб доступен в ЛК (`/trust`) и админке (`/admin/trust`): создание, просмотр, переписка, смена статусов. |
| US15 Модерация контента | Частично | Есть backend moderation actions + audit trail; UI и процессные SLA остаются в бэклоге. |
| US16 Верификация регалий | Частично | Upload/review UI+API реализованы, но сценарий чата по конкретной заявке регалии пока без deep-link к нужному пользователю. |

## 5) Рекомендуемый порядок закрытия разрывов

1. Дошлифовать trust-контур под формулировки отчета: deep-link в чат по конкретной регалии/жалобе и операторские UX-сценарии без ручных обходов.
2. Довести payouts/notifications до production-уровня: автоначисления, не-mock очереди email, push delivery, refund-оркестрация.
3. Зафиксировать NFR как исполняемые артефакты: нагрузочные тесты, SLO/SLA, retention jobs, observability метрики.
